name: Archive Completed Trades
on:
  push:
    paths:
      - 'signal.json'

jobs:
  archive:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Process Trade Logic
        run: |
          # Use Python to handle the JSON move safely
          python3 -c "
          import json, os
          with open('signal.json', 'r') as f:
              signal = json.load(f)
          
          if signal.get('status') == 'COMPLETED':
              with open('history.json', 'r') as f:
                  history = json.load(f)
              
              # Add the trade to the top of the history list
              history.insert(0, signal)
              
              # Keep only the last 50 trades to keep the site fast
              history = history[:50]
              
              with open('history.json', 'w') as f:
                  json.dump(history, f, indent=2)
              
              # Reset signal.json back to AWAITING
              reset_signal = {
                  'id': 'IDLE',
                  'type': 'AWAITING',
                  'price': '0.00',
                  'tp': '0.00',
                  'sl': '0.00',
                  'status': 'IDLE',
                  'result': 'N/A',
                  'date': 'N/A'
              }
              with open('signal.json', 'w') as f:
                  json.dump(reset_signal, f, indent=2)
          "
          
      - name: Save Changes
        run: |
          git config user.name "CRYO-JANITOR"
          git config user.email "bot@github.com"
          git add signal.json history.json
          git commit -m "Automated Archive: Trade moved to history" || exit 0
          git push
